



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://pages.charlesreid1.com/pod-charlesreid1/Service_nginx/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="..">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.3">
    
    
      
        <title>Pod Service: nginx - pod-charlesreid1</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#nginx" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://pages.charlesreid1.com/pod-charlesreid1" title="pod-charlesreid1" class="md-header-nav__button md-logo">
          
            <i class="md-icon">dns</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                pod-charlesreid1
              </span>
              <span class="md-header-nav__topic">
                Pod Service: nginx
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://git.charlesreid1.com/docker/pod-charlesreid1" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      pod-charlesreid1
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://pages.charlesreid1.com/pod-charlesreid1" title="pod-charlesreid1" class="md-nav__button md-logo">
      
        <i class="md-icon">dns</i>
      
    </a>
    pod-charlesreid1
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://git.charlesreid1.com/docker/pod-charlesreid1" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      pod-charlesreid1
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Index" class="md-nav__link">
      Index
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Service_mediawiki/" title="Pod Service: MediaWiki" class="md-nav__link">
      Pod Service: MediaWiki
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Service_apachephp/" title="Pod Service: Apache/PHP" class="md-nav__link">
      Pod Service: Apache/PHP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Service_mysql/" title="Pod Service: MySQL" class="md-nav__link">
      Pod Service: MySQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Service_phpmyadmin/" title="Pod Service: phpMyAdmin" class="md-nav__link">
      Pod Service: phpMyAdmin
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Pod Service: nginx
      </label>
    
    <a href="./" title="Pod Service: nginx" class="md-nav__link md-nav__link--active">
      Pod Service: nginx
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-files" title="Configuration Files" class="md-nav__link">
    Configuration Files
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#where-are-the-nginx-config-files" title="Where are the nginx config files?" class="md-nav__link">
    Where are the nginx config files?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-files-are-there" title="What Files Are There?" class="md-nav__link">
    What Files Are There?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-config-files" title="HTTP Config Files" class="md-nav__link">
    HTTP Config Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-config-files" title="HTTPS Config Files" class="md-nav__link">
    HTTPS Config Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-subdomain-config-files" title="HTTPS Subdomain Config Files" class="md-nav__link">
    HTTPS Subdomain Config Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-all-the-config-files" title="Why All The Config Files?" class="md-nav__link">
    Why All The Config Files?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-configuration-files-into-container" title="Getting Configuration Files Into Container" class="md-nav__link">
    Getting Configuration Files Into Container
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-content" title="Static Content" class="md-nav__link">
    Static Content
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#outside-the-container-www" title="Outside the Container: /www/" class="md-nav__link">
    Outside the Container: /www/
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inside-the-container-usrsharenginxhtml" title="Inside the Container: /usr/share/nginx/html" class="md-nav__link">
    Inside the Container: /usr/share/nginx/html
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utility-scripts-updating-site-contents" title="Utility Scripts: Updating Site Contents" class="md-nav__link">
    Utility Scripts: Updating Site Contents
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ssl-certificates" title="SSL Certificates" class="md-nav__link">
    SSL Certificates
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#where-to-put-certificates" title="Where To Put Certificates" class="md-nav__link">
    Where To Put Certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#which-server-needs-certificates" title="Which Server Needs Certificates" class="md-nav__link">
    Which Server Needs Certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-and-renewing-certificates" title="Getting and Renewing Certificates" class="md-nav__link">
    Getting and Renewing Certificates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-control" title="Domain Control" class="md-nav__link">
    Domain Control
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Service_pythonfiles/" title="Pod Service: Python File Server" class="md-nav__link">
      Pod Service: Python File Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Service_gitea/" title="Pod Service: Gitea" class="md-nav__link">
      Pod Service: Gitea
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Running/" title="Running the Pod" class="md-nav__link">
      Running the Pod
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Volumes/" title="Volumes" class="md-nav__link">
      Volumes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Backups/" title="Backups" class="md-nav__link">
      Backups
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Ports/" title="Domains and Ports" class="md-nav__link">
      Domains and Ports
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Secrets/" title="Secrets" class="md-nav__link">
      Secrets
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-files" title="Configuration Files" class="md-nav__link">
    Configuration Files
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#where-are-the-nginx-config-files" title="Where are the nginx config files?" class="md-nav__link">
    Where are the nginx config files?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-files-are-there" title="What Files Are There?" class="md-nav__link">
    What Files Are There?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-config-files" title="HTTP Config Files" class="md-nav__link">
    HTTP Config Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-config-files" title="HTTPS Config Files" class="md-nav__link">
    HTTPS Config Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#https-subdomain-config-files" title="HTTPS Subdomain Config Files" class="md-nav__link">
    HTTPS Subdomain Config Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-all-the-config-files" title="Why All The Config Files?" class="md-nav__link">
    Why All The Config Files?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-configuration-files-into-container" title="Getting Configuration Files Into Container" class="md-nav__link">
    Getting Configuration Files Into Container
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-content" title="Static Content" class="md-nav__link">
    Static Content
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#outside-the-container-www" title="Outside the Container: /www/" class="md-nav__link">
    Outside the Container: /www/
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inside-the-container-usrsharenginxhtml" title="Inside the Container: /usr/share/nginx/html" class="md-nav__link">
    Inside the Container: /usr/share/nginx/html
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utility-scripts-updating-site-contents" title="Utility Scripts: Updating Site Contents" class="md-nav__link">
    Utility Scripts: Updating Site Contents
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ssl-certificates" title="SSL Certificates" class="md-nav__link">
    SSL Certificates
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#where-to-put-certificates" title="Where To Put Certificates" class="md-nav__link">
    Where To Put Certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#which-server-needs-certificates" title="Which Server Needs Certificates" class="md-nav__link">
    Which Server Needs Certificates
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-and-renewing-certificates" title="Getting and Renewing Certificates" class="md-nav__link">
    Getting and Renewing Certificates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#domain-control" title="Domain Control" class="md-nav__link">
    Domain Control
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="nginx">Nginx<a class="headerlink" href="#nginx" title="Permanent link">&para;</a></h1>
<p>This describes the configuration of the main nginx container
for the charlesreid1.com pod.</p>
<h2 id="configuration-files">Configuration Files<a class="headerlink" href="#configuration-files" title="Permanent link">&para;</a></h2>
<p>The nginx container is critical to routing operations on
charlesreid1.com, so we cover how the configuration files
are split up and organized on this page, and include
a summary of each file below.</p>
<h3 id="where-are-the-nginx-config-files">Where are the nginx config files?<a class="headerlink" href="#where-are-the-nginx-config-files" title="Permanent link">&para;</a></h3>
<p>Nginx configuration files are located in the <code>d-nginx-charlesreid1</code>
submodule of this repository, which points to the
<a href="https://git.charlesreid1.com/docker/d-nginx-charlesreid1">docker/d-nginx-charlesreid1</a>
repository.</p>
<p>Within that repository is the <a href="https://git.charlesreid1.com/docker/d-nginx-charlesreid1/src/branch/master/conf.d"><code>conf.d/</code></a>
folder, which contains several <code>.conf</code> files.</p>
<h3 id="what-files-are-there">What Files Are There?<a class="headerlink" href="#what-files-are-there" title="Permanent link">&para;</a></h3>
<p>We have three sets of files present:</p>
<p>HTTP config files that redirect HTTP traffic on port 80 to
be HTTPS traffic on port 443, one for each top-level domain
(charlesreid1.com, charlesreid1.blue, and charlesreid1.red):</p>
<ul>
<li><code>http.com.charlesreid1.conf</code></li>
<li><code>http.red.charlesreid1.conf</code></li>
<li><code>http.blue.charlesreid1.conf</code></li>
</ul>
<p>HTTPS rules for charlesreid1.com endpoints (the wiki,
phpMyAdmin, and ignoring <code>.git</code> directories):</p>
<ul>
<li><code>https.com.charlesreid1.conf</code></li>
<li><code>https.red.charlesreid1.conf</code></li>
<li><code>https.blue.charlesreid1.conf</code></li>
</ul>
<p>HTTPS rules for subdomains (pages.charlesreid1.com,
hooks.charlesreid1.com, bots.charlesreid1.com):</p>
<ul>
<li><code>https.com.charlesreid1.subdomains.conf</code></li>
<li><code>https.red.charlesreid1.subdomains.conf</code></li>
<li><code>https.blue.charlesreid1.subdomains.conf</code></li>
</ul>
<h3 id="http-config-files">HTTP Config Files<a class="headerlink" href="#http-config-files" title="Permanent link">&para;</a></h3>
<p>The HTTP config files are listed below:</p>
<ul>
<li><code>http.com.charlesreid1.conf</code></li>
<li><code>http.red.charlesreid1.conf</code></li>
<li><code>http.blue.charlesreid1.conf</code></li>
</ul>
<p>The HTTP config files do the following:</p>
<ul>
<li>Requests for port 80 (for a domain or subdomain) are always redirected
  to port 443 for the same domain/subdomain</li>
</ul>
<h3 id="https-config-files">HTTPS Config Files<a class="headerlink" href="#https-config-files" title="Permanent link">&para;</a></h3>
<p>The HTTPS config files are listed below:</p>
<ul>
<li><code>https.com.charlesreid1.conf</code></li>
<li><code>https.red.charlesreid1.conf</code></li>
<li><code>https.blue.charlesreid1.conf</code></li>
</ul>
<p>The HTTPS config files (without "subdomain" in their name) do the following:</p>
<ul>
<li>
<p>Requests for <code>/</code> are redirected to the htdocs folders mentioned above</p>
</li>
<li>
<p>Requests for <code>/w/</code> or <code>/wiki/</code> are reverse-proxied to the local
  <a href="../Service_apachephp/">Apache+PHP container</a> on port 8989</p>
</li>
<li>
<p>(Optional) requests for <code>/phpMyAdmin/</code> are reverse-proxied to the local
  <a href="../Service_phpmyadmin/">phpMyAdmin container</a> on port 80</p>
</li>
<li>
<p>Requests for <code>git.charlesreid1.com</code> are reverse-proxied to the local
  <a href="../Service_gitea/">Gitea container</a> on port 3000</p>
</li>
<li>
<p>Requests for <code>files.charlesreid1.com</code> are reverse-proxied to the local
  <a href="../Service_pythonfiles/">Python files</a> on port 8081</p>
</li>
</ul>
<h3 id="https-subdomain-config-files">HTTPS Subdomain Config Files<a class="headerlink" href="#https-subdomain-config-files" title="Permanent link">&para;</a></h3>
<p>The HTTPS subdomain config files are listed below:</p>
<ul>
<li><code>https.com.charlesreid1.subdomains.conf</code></li>
<li><code>https.red.charlesreid1.subdomains.conf</code></li>
<li><code>https.blue.charlesreid1.subdomains.conf</code></li>
</ul>
<p>The subdomains config files redirect requests for a set of subdomains
on charlesreid1.com, namely:</p>
<ul>
<li><code>pages.charlesreid1.com</code></li>
<li><code>hooks.charlesreid1.com</code></li>
<li><code>bots.charlesreid1.com</code></li>
</ul>
<p>This charlesreid1.com docker pod will redirect requests for these subdomains
to another server running another docker pod, called the webhook docker pod,
available at <a href="https://git.charlesreid1.com/docker/pod-webhooks">docker/pod-webhooks</a>).</p>
<p>The webhook docker pod runs an nginx server, both to serve up static sites that live
under the <a href="https://pages.charlesreid1.com">https://pages.charlesreid1.com</a> domain, and to handle webhook traffic - the 
container also runs a Python webhook server that receives webhooks from git.charlesreid1.com,
which enables push-to-deploy functionality similar to Github Pages.</p>
<p>Also see <a href="https://pages.charlesreid1.com/pod-webhooks/">https://pages.charlesreid1.com/pod-webhooks/</a>.</p>
<h3 id="why-all-the-config-files">Why All The Config Files?<a class="headerlink" href="#why-all-the-config-files" title="Permanent link">&para;</a></h3>
<p>If everything is stuffed into a smaller number of
nginx config files, they become long and unwieldy,
and more prone to mistakes.</p>
<ul>
<li>HTTP config files only contain redirects</li>
<li>HTTPS (no subdomain) config files handle </li>
</ul>
<h3 id="getting-configuration-files-into-container">Getting Configuration Files Into Container<a class="headerlink" href="#getting-configuration-files-into-container" title="Permanent link">&para;</a></h3>
<p>The configuration files are mounted into the container
by bind-mounting the <code>conf.d</code> folder of the <code>d-nginx-charlesreid1</code>
submodule at <code>/et/nginx/conf.d</code> in the container.</p>
<p>This is done in the <a href="https://git.charlesreid1.com/docker/pod-charlesreid1/src/branch/master/docker-compose.fixme.yml#L57">charlesreid1 pod docker-compose
file</a>.</p>
<h2 id="static-content">Static Content<a class="headerlink" href="#static-content" title="Permanent link">&para;</a></h2>
<p>The nginx container hosts static content, in addition to serving
as a reverse-proxy for several other services. This section covers
how static content is treated by the charlesreid1.com nginx
container</p>
<h3 id="outside-the-container-www">Outside the Container: <code>/www/</code><a class="headerlink" href="#outside-the-container-www" title="Permanent link">&para;</a></h3>
<p>Static content hosted by the container is stored on the host
machine in <code>/www/</code>. </p>
<p>Each site (e.g., charlesreid1.com) has its own folder, containing
the source for the static site and an htdocs folder containing the
static content actually being hosted.</p>
<p>Additionally, because the static content for the site is actually
contained on the <code>gh-pages</code> branch of <a href="https://git.charlesreid1.com/charlesreid1/charlesreid1.com">charlesreid1/charlesreid1.com</a>,
the <code>htodcs</code> folder is actually a git repository. When it is
cloned, it is cloned such that the git repo's contents go into 
<code>/www/charlesreid1.com/htdocs/</code> and the contents of the <code>.git</code>
folder go into <code>/www/charlesreid1.com/git</code>.</p>
<p>This allows the site static content to be updated to reflect the
contents of the <code>gh-pages</code> branch by pulling the latest upstream
changes into htdocs.</p>
<p>The directory structure used is as follows:</p>
<div class="codehilite"><pre><span></span>/www
    /charlesreid1.com
        /charlesreid1-src
            ...source for pelican site... 
        /htdocs
            ...static content...
        /git
            ...dot git folder...

    /charlesreid1.blue
        /charlesreid1-blue-src
            ...source for pelican site... 
        /htodcs
            ...static content...
        /git
            ...dot git folder...

    /charlesreid1.red
        /charlesreid1-red-src
            ...source for pelican site... 
        /htodcs
            ...static content...
        /git
            ...dot git folder...
</pre></div>


<p>This directory structure can be achieved using the following 
bash command:</p>
<div class="codehilite"><pre><span></span>REPOURL=&quot;https://git.charlesreid1.com/charlesreid1/charlesreid1.com.git&quot;

git -C /www/example.com \
    clone \
    --separate-git-dir=git \
    -b gh-pages \
    $REPOURL htdocs
</pre></div>


<p>The <a href="https://git.charlesreid1.com/debian/dotfiles">dotfiles/debian</a>
repository contains scripts for krash, which runs the charlesreid1.com
pod, to set up the directory structure as above, as well as scripts
to pull the latest changes from upstream for each of the live
web directories above.</p>
<h3 id="inside-the-container-usrsharenginxhtml">Inside the Container: <code>/usr/share/nginx/html</code><a class="headerlink" href="#inside-the-container-usrsharenginxhtml" title="Permanent link">&para;</a></h3>
<p>Once the contents of the <code>/www/</code> directory have been set up,
the content can be made avialable inside the container by 
bind-mounting the htdocs directories into the <code>/www/</code> directory
inside the container. This is done with the following
volume directives in the <a href="https://git.charlesreid1.com/docker/pod-charlesreid1/src/branch/master/docker-compose.fixme.yml#L60-L62"><code>docker-compose.yml</code> file</a>:</p>
<div class="codehilite"><pre><span></span>    volumes:
      - &quot;/www/charlesreid1.blue/htdocs:/www/charlesreid1.blue/htdocs:ro&quot;
      - &quot;/www/charlesreid1.red/htdocs:/www/charlesreid1.red/htdocs:ro&quot;
      - &quot;/www/charlesreid1.com/htdocs:/www/charlesreid1.com/htdocs:ro&quot;
      ...
</pre></div>


<h3 id="utility-scripts-updating-site-contents">Utility Scripts: Updating Site Contents<a class="headerlink" href="#utility-scripts-updating-site-contents" title="Permanent link">&para;</a></h3>
<p>In the <a href="https://git.charlesreid1.com/dotfiles/debian/src/branch/master/dotfiles/krash_scripts"><code>krash_scripts/</code> folder</a>
of the debian/dotfiles](https://git.charlesreid1.com/dotfiles/debian)
repository, there are several utility scripts to help with
setting up and updating this directory structure.</p>
<p>To set up the directory structure, use the <a href="https://git.charlesreid1.com/dotfiles/debian/src/branch/master/dotfiles/krash_scripts/git_clone_www.sh"><code>git_clone_www.sh</code> script</a>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">REPOURL</span><span class="o">=</span><span class="s2">&quot;https://git.charlesreid1.com/charlesreid1/charlesreid1.com.git&quot;</span>

git -C /www/example.com <span class="se">\</span>
    clone <span class="se">\</span>
    --separate-git-dir<span class="o">=</span>git <span class="se">\</span>
    -b gh-pages <span class="se">\</span>
    <span class="nv">$REPOURL</span> htdocs
</pre></div>
</td></tr></table>

<p>To update the contents of the <code>htdocs/</code> folder using the latest changes
on the <code>gh-pages</code> branch, use the <a href="https://git.charlesreid1.com/dotfiles/debian/src/branch/master/dotfiles/krash_scripts/git_pull_www.sh"><code>git_pull_www.sh</code> script</a>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

git -C /www/example.com <span class="se">\</span>
    --git-dir<span class="o">=</span>git --work-tree<span class="o">=</span>htdocs <span class="se">\</span>
    pull origin gh-pages
</pre></div>
</td></tr></table>

<h2 id="ssl-certificates">SSL Certificates<a class="headerlink" href="#ssl-certificates" title="Permanent link">&para;</a></h2>
<p>We utilize Let's Encrypt to issue SSL certificates for our domain.
This is a pain because of the need to automatically renew certificates
every 90 days, and because of missing information in their documentation.</p>
<h3 id="where-to-put-certificates">Where To Put Certificates<a class="headerlink" href="#where-to-put-certificates" title="Permanent link">&para;</a></h3>
<p>We leave the certificates where Let's Encrypt puts them, namely, in <code>/etc/letsencrypt/live</code>.</p>
<p>The certificates are bind-mounted into the container at the same location,
<code>/etc/letsencrypt/live</code>. The <a href="#"><code>docker-compose.yml</code> file</a>
then contains the following:</p>
<div class="codehilite"><pre><span></span>    volumes:
      - &quot;/etc/letsencrypt:/etc/letsencrypt&quot;
      ...
</pre></div>


<h3 id="which-server-needs-certificates">Which Server Needs Certificates<a class="headerlink" href="#which-server-needs-certificates" title="Permanent link">&para;</a></h3>
<p>Because the <a href="#">d-nginx-charlesreid1 docker container</a>
is serving as the front-end nginx server handling all
incoming charlesreid1.com web requests, it is also the
one negotiating HTTPS sessions with clients, so it is
the container that needs the Let's Encrypt certificates.</p>
<p>This means that, for example, the SSL certificate for 
<code>pages.charlesreid1.com</code> is on krash, even though the
content served up by the site is on blackbeard.</p>
<h3 id="getting-and-renewing-certificates">Getting and Renewing Certificates<a class="headerlink" href="#getting-and-renewing-certificates" title="Permanent link">&para;</a></h3>
<p>Once you have worked everything out and gotten auto-renew cron scripts
running smoothly, everything is unicorns and rainbows. But when you hit
the Let's Encrypt rate limit because they did not explain it properly
in the documentation, you may want everyone to die.</p>
<p>Let's Encrypt provides a command line utility called certbot that can be
used to automate the process of creating and renewing certificates.</p>
<p>See the <a href="https://git.charlesreid1.com/charlesreid1/certbot">charlesreid1/certbot</a>
repository for scripts. The basic setup is as follows:</p>
<ul>
<li>
<p>Use the <a href="https://git.charlesreid1.com/charlesreid1/certbot/src/branch/master/krash_make_cert.sh"><code>krash_make_cert.sh</code></a>
  script (which wraps the <a href="https://git.charlesreid1.com/charlesreid1/certbot/src/branch/master/make_cert.sh"><code>make_cert.sh</code></a>
  script) to create SSL certificates for each domain and subdomain</p>
</li>
<li>
<p>Use the <a href="https://git.charlesreid1.com/charlesreid1/certbot/src/branch/master/krash_renew.sh"><code>krash_renew.sh</code></a>
  script (which wraps the <a href="https://git.charlesreid1.com/charlesreid1/certbot/src/branch/master/renew_cert.sh"><code>renew_cert.sh</code></a>
  script) to renew SSL certificates for each domain and subdomain</p>
</li>
<li>
<p>Certificates must be renewed every 90 days. I run the certificate renewal
  script in the root acount's crontab every 15 days so the certs never expire.</p>
</li>
</ul>
<h2 id="domain-control">Domain Control<a class="headerlink" href="#domain-control" title="Permanent link">&para;</a></h2>
<p>There are three top-level domains controlled by pod-charlesreid1:</p>
<ul>
<li><a href="https://charlesreid1.com">https://charlesreid1.com</a></li>
<li><a href="https://charlesreid1.blue">https://charlesreid1.blue</a></li>
<li><a href="https://charlesreid1.red">https://charlesreid1.red</a></li>
</ul>
<p>There are several subdomains available on charlesreid1.com.</p>
<p>Hosted on krash:</p>
<ul>
<li><a href="https://git.charlesreid1.com">https://git.charlesreid1.com</a> - gitea service</li>
<li><a href="https://files.charlesreid1.com">https://files.charlesreid1.com</a> - static file hosting</li>
</ul>
<p>Hosted on blackbeard:</p>
<ul>
<li><a href="https://pages.charlesreid1.com">https://pages.charlesreid1.com</a> - push-to-deploy static pages</li>
<li><a href="https://hooks.charlesreid1.com">https://hooks.charlesreid1.com</a> - webhook server</li>
<li><a href="https://bots.charlesreid1.com">https://bots.charlesreid1.com</a> - info about bots</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Service_phpmyadmin/" title="Pod Service: phpMyAdmin" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Pod Service: phpMyAdmin
              </span>
            </div>
          </a>
        
        
          <a href="../Service_pythonfiles/" title="Pod Service: Python File Server" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Pod Service: Python File Server
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="https://charlesreid1.com">Charles Reid</a>, released under the <a href="https://opensource.org/licenses/MIT">MIT license</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.e72fd936.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../search/main.js"></script>
      
    
    
      
    
  </body>
</html>